<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RP-Event Kalender</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/5.11.3/main.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/5.11.3/main.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        #calendar { max-width: 800px; margin: 40px auto; }
    </style>
</head>
<body>
    <h1>ðŸ“… RP-Event Kalender</h1>
    <p>Trage dich direkt fÃ¼r ein Event ein!</p>
    <div id="calendar"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let calendarEl = document.getElementById('calendar');
            let repoOwner = "OnkelHomie";  // GitHub Benutzername
            let repoName = "test";  // Name des Repositories
            let filePath = "events.json";
            let token = "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";  // Sicher speichern!
            let apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`;

            async function fetchEvents() {
                let response = await fetch(apiUrl, {
                    headers: { "Authorization": `token ${token}` }
                });
                let data = await response.json();
                return JSON.parse(atob(data.content));
            }

            async function updateEvent(eventTitle, userName) {
                let response = await fetch(apiUrl, {
                    headers: { "Authorization": `token ${token}` }
                });
                let data = await response.json();
                let events = JSON.parse(atob(data.content));

                let event = events.find(e => e.title === eventTitle);
                if (event) {
                    event.extendedProps.teilnehmer.push(userName);
                } else {
                    alert("Event nicht gefunden!");
                    return;
                }

                let updatedContent = btoa(JSON.stringify(events, null, 2));

                await fetch(apiUrl, {
                    method: "PUT",
                    headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        message: `Teilnehmer hinzugefÃ¼gt: ${userName}`,
                        content: updatedContent,
                        sha: data.sha
                    })
                });

                alert(`${userName} wurde fÃ¼r ${eventTitle} eingetragen!`);
            }

            fetchEvents().then(events => {
                let calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    events: events,
                    eventClick: function(info) {
                        let name = prompt('Gib deinen Namen ein, um dich fÃ¼r dieses Event anzumelden:');
                        if (name) {
                            updateEvent(info.event.title, name);
                        }
                    }
                });
                calendar.render();
            });
        });
    </script>
</body>
</html>
