<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RP-Event Kalender</title>
    
    <!-- Korrekte DayPilot Quelle -->
    <script src="https://unpkg.com/daypilot-lite@latest/daypilot-all.min.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        #calendar { max-width: 800px; margin: 40px auto; height: 600px; }
    </style>
</head>
<body>
    <h1>ğŸ“… RP-Event Kalender</h1>
    <p>Neue Termine kÃ¶nnen direkt im Kalender erstellt werden. Teilnehmer kÃ¶nnen sich eintragen!</p>
    <div id="calendar"></div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            console.log("DayPilot Kalender geladen");

            let calendarEl = document.getElementById('calendar');
            let sheetUrl = "https://script.google.com/macros/s/AKfycbxLFbguGbBRS1OeUQFg99SoX_6kDSkICRssF9W2TaBzhvjbnxgsbdLEMgug1ygyQIdk/exec";

            async function fetchEvents() {
                try {
                    let response = await fetch(sheetUrl + "?action=get");
                    if (!response.ok) throw new Error("Fehler beim Abrufen der Events");
                    let data = await response.json();
                    console.log("Geladene Events:", data);
                    return data.map(event => ({
                        id: event.id,
                        text: event.title,
                        start: event.start,
                        end: event.start // DayPilot benÃ¶tigt Start/Ende
                    }));
                } catch (error) {
                    console.error(error);
                    return [];
                }
            }

            async function updateEvent(eventTitle, userName) {
                try {
                    let response = await fetch(sheetUrl, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ action: "update", event: eventTitle, name: userName })
                    });
                    if (!response.ok) throw new Error("Fehler beim Eintragen des Teilnehmers");
                    let result = await response.text();
                    alert(result);
                    location.reload();
                } catch (error) {
                    console.error(error);
                }
            }

            async function createEvent(eventTitle, eventDate) {
                try {
                    let response = await fetch(sheetUrl, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ action: "create", title: eventTitle, date: eventDate })
                    });
                    if (!response.ok) throw new Error("Fehler beim Erstellen des Events");
                    let result = await response.text();
                    alert(result);
                    location.reload();
                } catch (error) {
                    console.error(error);
                }
            }

            const calendar = new DayPilot.Calendar("calendar");
            calendar.viewType = "Month";
            
            fetchEvents().then(events => {
                calendar.events.list = events;
                calendar.onTimeRangeSelected = async function(args) {
                    let title = prompt("Gib den Event-Titel ein:");
                    if (title) {
                        await createEvent(title, args.start);
                    }
                };
                calendar.onEventClick = async function(args) {
                    let name = prompt("Gib deinen Namen ein, um dich fÃ¼r dieses Event anzumelden:");
                    if (name) {
                        await updateEvent(args.e.text(), name);
                    }
                };
                calendar.init();
            }).catch(error => console.error("Fehler beim Laden des Kalenders:", error));
        });
    </script>
</body>
</html>
