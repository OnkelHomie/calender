<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RP-Event Kalender</title>
    
    <!-- FullCalendar Stylesheet -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css" rel="stylesheet">
    
    <!-- Lade jQuery zuerst -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    
    <!-- Lade FullCalendar danach -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        #calendar { max-width: 800px; margin: 40px auto; height: 600px; }
    </style>
</head>
<body>
    <h1>ğŸ“… RP-Event Kalender</h1>
    <p>Neue Termine kÃ¶nnen direkt im Kalender erstellt werden. Teilnehmer kÃ¶nnen sich eintragen!</p>
    <div id="calendar"></div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            console.log("FullCalendar geladen:", typeof FullCalendar);

            let calendarEl = document.getElementById('calendar');
            let sheetUrl = "https://script.google.com/macros/s/AKfycbxLFbguGbBRS1OeUQFg99SoX_6kDSkICRssF9W2TaBzhvjbnxgsbdLEMgug1ygyQIdk/exec";

            async function fetchEvents() {
                try {
                    let response = await fetch(sheetUrl + "?action=get");
                    if (!response.ok) throw new Error("Fehler beim Abrufen der Events");
                    let data = await response.json();
                    console.log("Geladene Events:", data);
                    return data;
                } catch (error) {
                    console.error(error);
                    return [];
                }
            }

            async function updateEvent(eventTitle, userName) {
                try {
                    let response = await fetch(sheetUrl, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ action: "update", event: eventTitle, name: userName })
                    });
                    if (!response.ok) throw new Error("Fehler beim Eintragen des Teilnehmers");
                    let result = await response.text();
                    alert(result);
                    location.reload();
                } catch (error) {
                    console.error(error);
                }
            }

            async function createEvent(eventTitle, eventDate, eventTime) {
                try {
                    let response = await fetch(sheetUrl, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ action: "create", title: eventTitle, date: eventDate, time: eventTime })
                    });
                    if (!response.ok) throw new Error("Fehler beim Erstellen des Events");
                    let result = await response.text();
                    alert(result);
                    location.reload();
                } catch (error) {
                    console.error(error);
                }
            }

            fetchEvents().then(events => {
                let calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    editable: true,
                    selectable: true,
                    events: fetchEvents,
                    select: async function(info) {
                        let title = prompt("Gib den Event-Titel ein:");
                        let time = prompt("Gib die Uhrzeit ein (HH:MM):");
                        if (title && time) {
                            await createEvent(title, info.startStr, time);
                        }
                    },
                    eventClick: async function(info) {
                        let name = prompt('Gib deinen Namen ein, um dich fÃ¼r dieses Event anzumelden:');
                        if (name) {
                            await updateEvent(info.event.title, name);
                        }
                    }
                });
                calendar.render();
            }).catch(error => console.error("Fehler beim Laden des Kalenders:", error));
        });
    </script>
</body>
</html>
