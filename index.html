<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RP-Event Kalender</title>
    
    <!-- FullCalendar Quellen -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.5/main.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.5/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        #calendar { max-width: 800px; margin: 40px auto; height: 600px; }
    </style>
</head>
<body>
    <h1>ðŸ“… RP-Event Kalender</h1>
    <p>Neue Termine kÃ¶nnen direkt im Kalender erstellt werden. Teilnehmer kÃ¶nnen sich eintragen!</p>
    <div id="calendar"></div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            console.log("FullCalendar geladen");

            let calendarEl = document.getElementById('calendar');
            let sheetUrl = "https://script.google.com/macros/s/AKfycbxLFbguGbBRS1OeUQFg99SoX_6kDSkICRssF9W2TaBzhvjbnxgsbdLEMgug1ygyQIdk/exec";

            let calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                selectable: true,
                editable: true,
                eventClick: function(info) {
                    let name = prompt("Gib deinen Namen ein, um dich fÃ¼r dieses Event anzumelden:");
                    if (name) {
                        updateEvent(info.event.title, name);
                    }
                },
                dateClick: function(info) {
                    let title = prompt("Gib den Event-Titel ein:");
                    if (title) {
                        createEvent(title, info.dateStr);
                    }
                }
            });
            calendar.render();

            async function fetchEvents() {
                try {
                    let response = await fetch(sheetUrl + "?action=get");
                    if (!response.ok) throw new Error("Fehler beim Abrufen der Events");
                    let data = await response.json();
                    console.log("Geladene Events:", data);
                    calendar.addEventSource(data.map(event => ({
                        title: event.title,
                        start: event.start
                    })));
                } catch (error) {
                    console.error(error);
                }
            }

            async function updateEvent(eventTitle, userName) {
                try {
                    let response = await fetch(sheetUrl, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ action: "update", event: eventTitle, name: userName })
                    });
                    if (!response.ok) throw new Error("Fehler beim Eintragen des Teilnehmers");
                    let result = await response.text();
                    alert(result);
                    location.reload();
                } catch (error) {
                    console.error(error);
                }
            }

            async function createEvent(eventTitle, eventDate) {
                try {
                    let response = await fetch(sheetUrl, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ action: "create", title: eventTitle, date: eventDate })
                    });
                    if (!response.ok) throw new Error("Fehler beim Erstellen des Events");
                    let result = await response.text();
                    alert(result);
                    location.reload();
                } catch (error) {
                    console.error(error);
                }
            }

            fetchEvents();
        });
    </script>
</body>
</html>
